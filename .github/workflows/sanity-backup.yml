name: Sanity Daily Backup

on:
  schedule:
    - cron: '0 3 * * *'  # каждый день в 3:00 UTC
  workflow_dispatch:      # можно запустить вручную

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Sanity project
        run: |
          # Создаем минимальный package.json
          npm init -y
          
          # Устанавливаем Sanity CLI локально
          npm install @sanity/cli
          
          # Создаем минимальный sanity.config.js
          cat > sanity.config.js << EOF
          import {defineConfig} from 'sanity'
          
          export default defineConfig({
            projectId: '${{ secrets.SANITY_PROJECT_ID }}',
            dataset: 'production',
          })
          EOF

      - name: Export dataset with assets
        run: |
          # Экспортируем все данные включая assets через Sanity CLI
          npx sanity dataset export production backup.tar.gz --assets
          
          # Показываем размер бэкапа
          echo "Backup completed!"
          ls -lh backup.tar.gz
          
          # Переименовываем с датой
          BACKUP_DATE=$(date +%Y-%m-%d_%H-%M-%S)
          mv backup.tar.gz sanity-backup-${BACKUP_DATE}.tar.gz
        env:
          SANITY_AUTH_TOKEN: ${{ secrets.SANITY_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        run: |
          # Находим файл бэкапа (с датой в имени)
          BACKUP_FILE=$(ls sanity-backup-*.tar.gz)
          echo "Uploading ${BACKUP_FILE} to S3..."
          
          aws s3 cp ${BACKUP_FILE} s3://${{ secrets.S3_BUCKET }}/backups/${BACKUP_FILE}
          
          echo "Backup successfully uploaded to S3!"
          echo "Location: s3://${{ secrets.S3_BUCKET }}/backups/${BACKUP_FILE}"
